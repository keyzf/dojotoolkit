<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script type="text/javascript" src="../../../dojo/dojo.js"
		djConfig="isDebug: true, parseOnLoad: true"></script>
	<script>
		dojo.require("dijit.layout.ContentPane");
	</script>
	<script>

		function t(node){ return node.innerText || node.textContent; };

		var languages, langCountryMap, continents, countries;

		// Call this first, to load JSON data from files (have to wait for load to finish)
		function load(){
			dojo.byId("json").value="";

			// Load list of continents
			var d = dojo.xhrGet({url: "continents.json", handleAs: "json-comment-optional"});
			d.addCallback(function(data){
				continents = data;
			});

			// Load country <--> continent mapping
			var d = dojo.xhrGet({url: "countries.txt", handleAs: "text"});
			d.addCallback(function(text){
				var rows = dojo.filter(text.split(/\n/), function(line){ return !line.match(/^\s*$/) && !line.match(/^#/); });
				countries = dojo.map(rows, function(line){
					var match = line.match(/^([A-Z]*) ([A-Z]*) ([A-Z]*) ([0-9]*) (.*)$/);
					return { key: "country:"+match[2], type: "country", iso: match[2], name: match[5], continent: match[1] };
				});
			});

			// Load mapping between countries and languages
			var d = dojo.xhrGet({url: "langCountryMap.json", handleAs: "json-comment-optional"});
			d.addCallback(function(data){
				langCountryMap = data;
				dojo.forEach(langCountryMap, function(entry){
					entry.iso = entry.language + "_" + entry.country;
					entry.key = "langCountryMap:"+entry.iso;
				});
			});

			// Load list of languages		
			var d2 = dojo.xhrGet({url: "languages.json", handleAs: "json-comment-optional"});
			d2.addCallback(function(data){
				// each data item X now contains a list every language, as written in
				// language X, but actually need to invert that for this demo
				languages = dojo.map(data, function(l){
					var item = {key: "language:"+l.iso, type: "language", iso: l.iso, name: l.name, countries: l.countries};
					dojo.forEach(data, function(fl){
						if(fl[l.iso]){
							//if(item.iso=="en") console.log("in " + fl.name + " the language " + l.name + "/" + l.iso + " is spelled as " + fl[l.iso]);
							item[fl.iso]=fl[l.iso];
						}
					});
					if(!item.name){ item.name = item.en || "unknown"; }
					return item;
				});
			});
		}

		function generate(){
			var out = dojo.byId("json");
			out.value = "Working...";

			// Generate country items
			dojo.forEach(countries, function(country){
				country.languages = dojo.filter(langCountryMap, function(x){
					return x.country==country.iso;
				}).map(function(x){
					return {_reference: "language:"+x.language};
				});
			});

			// generate json for data
			var json = {
				"identifier": 'key',
				"label": 'name',
				"items": [].concat(languages, continents, countries)
			};
			out.value = dojo.toJson(json, true);
		}
	</script>
</head>
<body>
<h1> Country / Language JSON Database Generator </h1>
<p>Push "load" then wait, then "generate".  Save results from textarea into data.json.</p>
<button onclick="load();">Load</button>
<button onclick="generate();">Generate</button>
<br>
<textarea id="json" cols=100 rows=20 autocomplete='off'></textarea>
</body>
</html>